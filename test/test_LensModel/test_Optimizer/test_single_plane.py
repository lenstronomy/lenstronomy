from lenstronomy.LensModel.Optimizer.optimizer import Optimizer
from lenstronomy.Util.util import sort_image_index
import numpy.testing as npt
import numpy as np
import pytest

class TestSinglePlaneOptimizer(object):

    x_pos = [-0.49598, 0.14184, -1.05127, 0.90563]
    y_pos = [0.97263, 1.04017, 0.11488, -1.22083]
    magnification_simple = [1, 0.676482, 0.376914, 0.198391]

    redshift_list_simple = [0.5, 0.5]
    lens_model_list_simple = ['SPEMD', 'SHEAR']
    kwargs_lens_simple = [{'theta_E': 1, 'center_x': 0.01, 'center_y': 0, 'e1': 0.0585665252864011, 'gamma': 2,
                           'e2': 0.08890716633399057}, {'e1': 0.00418890660015825, 'e2': -0.05908846518073248}]

    redshift_list_subs = [0.5] * 128
    lens_model_list_subs = lens_model_list_simple + ['TNFW']*126
    kwargs_lens_subs = [{'theta_E': 0.9, 'center_x': 0.01, 'center_y': 0, 'e1': 0.0985665252864011, 'gamma': 2, 'e2': -0.08890716633399057},{'e1': 0.010418890660015825, 'e2': -0.05908846518073248}, {'theta_Rs': 0.0003840954727584711, 'center_y': 1.1200307407998908, 'center_x': -1.8912603657478209, 'r_trunc': 0.16353543161632422, 'Rs': 0.02349088194655639}, {'theta_Rs': 0.0014421822134397, 'center_y': 0.8911932081300574, 'center_x': 1.8594329824114593, 'r_trunc': 0.2746253401497933, 'Rs': 0.05247265173141802}, {'theta_Rs': 0.0005357089424568492, 'center_y': 0.5618314164599562, 'center_x': 1.0468753476263422, 'r_trunc': 0.21107419783160736, 'Rs': 0.02409524220053008}, {'theta_Rs': 0.00028002528490389663, 'center_y': 0.17641438051320016, 'center_x': -1.206543551967472, 'r_trunc': 0.17927096030585513, 'Rs': 0.017591885002233378}, {'theta_Rs': 0.00023247929500764918, 'center_y': -2.1359345075579115, 'center_x': -1.7497439686034326, 'r_trunc': 0.14865799971383967, 'Rs': 0.017495487774622544}, {'theta_Rs': 0.00025138399383704395, 'center_y': 1.0368753411305318, 'center_x': 2.682402485134937, 'r_trunc': 0.09410734545302342, 'Rs': 0.012330105000087552}, {'theta_Rs': 0.0002626995506566308, 'center_y': 1.6490474146154812, 'center_x': 1.6900201629094171, 'r_trunc': 0.16141696264307762, 'Rs': 0.018100416627233717}, {'theta_Rs': 0.0001840534110874561, 'center_y': -1.558175107066062, 'center_x': 1.616393827724842, 'r_trunc': 0.13572513127357086, 'Rs': 0.01695845060493046}, {'theta_Rs': 0.00025388997906318896, 'center_y': 1.0008359556139292, 'center_x': -1.624791938838072, 'r_trunc': 0.08551774769100048, 'Rs': 0.01608029731620029}, {'theta_Rs': 0.00032036939084703186, 'center_y': -2.0450605966048627, 'center_x': -0.3197479383733344, 'r_trunc': 0.08443059589450932, 'Rs': 0.02276575539924489}, {'theta_Rs': 0.00018772571488261794, 'center_y': -0.0554816210464741, 'center_x': 2.244577856661678, 'r_trunc': 0.06911060463031996, 'Rs': 0.017840917159906506}, {'theta_Rs': 0.003227940432208753, 'center_y': -2.0214888441837378, 'center_x': 1.276528694911202, 'r_trunc': 0.8529784242697129, 'Rs': 0.11211679982031372}, {'theta_Rs': 0.0003572012688598166, 'center_y': 0.9468786654054197, 'center_x': 2.096358163031831, 'r_trunc': 0.09857108678170472, 'Rs': 0.02764913156127335}, {'theta_Rs': 0.003518569550603398, 'center_y': 2.5202788425667184, 'center_x': 0.9472763633395183, 'r_trunc': 0.37628862616152825, 'Rs': 0.08223007946698505}, {'theta_Rs': 0.0003388476553679151, 'center_y': -2.271766204752513, 'center_x': -0.8101855539566041, 'r_trunc': 0.12441068780953592, 'Rs': 0.021061618397344464}, {'theta_Rs': 0.0008898303770091648, 'center_y': 1.4265142552602486, 'center_x': 0.8639656123288642, 'r_trunc': 0.2547922209719316, 'Rs': 0.028699192988115452}, {'theta_Rs': 0.0002710236009420659, 'center_y': -2.031141004912268, 'center_x': 0.9466068202722537, 'r_trunc': 0.1067236084335172, 'Rs': 0.01443899684865517}, {'theta_Rs': 0.000304143358085919, 'center_y': 2.2908620083848117, 'center_x': 1.8537999322668908, 'r_trunc': 0.1318485332090729, 'Rs': 0.01956611306893903}, {'theta_Rs': 0.0008941812719814585, 'center_y': 0.4911683228932826, 'center_x': 0.1619682798120832, 'r_trunc': 0.11081586344483599, 'Rs': 0.046842852480620326}, {'theta_Rs': 0.0005002565291958646, 'center_y': 1.3700864350390995, 'center_x': -0.5457188971324096, 'r_trunc': 0.09210117095617078, 'Rs': 0.02349964854265881}, {'theta_Rs': 0.00020562186394786408, 'center_y': 1.0276911006735394, 'center_x': -1.0438625801881496, 'r_trunc': 0.09220202312961026, 'Rs': 0.015772144483855863}, {'theta_Rs': 0.0019545879256374133, 'center_y': -0.8478103407253859, 'center_x': 0.9036227047314332, 'r_trunc': 0.27984089431980363, 'Rs': 0.0471705699183234}, {'theta_Rs': 0.00017257212269359518, 'center_y': -2.0138544686241078, 'center_x': 1.8282784099878213, 'r_trunc': 0.13999578930793213, 'Rs': 0.020097503300824736}, {'theta_Rs': 0.00023418885768570629, 'center_y': -2.50053872106978, 'center_x': 0.39566020499137516, 'r_trunc': 0.08205186076167714, 'Rs': 0.018713085991368988}, {'theta_Rs': 0.00031221019737504827, 'center_y': -0.9161669347827676, 'center_x': -1.9885084048746404, 'r_trunc': 0.09171394819888896, 'Rs': 0.021203690160169555}, {'theta_Rs': 0.00020463431764356434, 'center_y': -0.37211776032824856, 'center_x': 0.7070351117003889, 'r_trunc': 0.06985613640876971, 'Rs': 0.015950028494792916}, {'theta_Rs': 0.00021546620809719512, 'center_y': 1.4273169919809918, 'center_x': 0.9982330880226405, 'r_trunc': 0.1269120115008531, 'Rs': 0.015276642648352656}, {'theta_Rs': 0.0003579261648664807, 'center_y': 1.123401806427993, 'center_x': -1.3030068711205351, 'r_trunc': 0.07790911538592142, 'Rs': 0.017202335040118647}, {'theta_Rs': 0.000306919820052703, 'center_y': 0.7537117723082662, 'center_x': -2.243788606660189, 'r_trunc': 0.14544508552310242, 'Rs': 0.020119069438750914}, {'theta_Rs': 0.0002492073320719331, 'center_y': -1.3490731375596632, 'center_x': 1.7374082390076717, 'r_trunc': 0.07104890362795989, 'Rs': 0.012154678774985309}, {'theta_Rs': 0.00031156655455236794, 'center_y': 2.936729937628133, 'center_x': 0.32477358841942316, 'r_trunc': 0.19361689819525132, 'Rs': 0.026241489950042322}, {'theta_Rs': 0.00021355010373349967, 'center_y': 2.3338123207602615, 'center_x': -0.32058221278066956, 'r_trunc': 0.08726911755409426, 'Rs': 0.01567166234939234}, {'theta_Rs': 0.00044298656853213015, 'center_y': 1.3509125300993945, 'center_x': 1.7713855059317558, 'r_trunc': 0.1611588500844162, 'Rs': 0.029166171775099375}, {'theta_Rs': 0.00042314386675421794, 'center_y': -1.0815332044190122, 'center_x': 2.162696151111951, 'r_trunc': 0.13102345843514798, 'Rs': 0.027238600215207555}, {'theta_Rs': 0.0002725921131083591, 'center_y': 0.20134537980207057, 'center_x': -2.0763156969666174, 'r_trunc': 0.07704630263978886, 'Rs': 0.018753449480173084}, {'theta_Rs': 0.0002406156185287424, 'center_y': 0.40866249647534336, 'center_x': 2.129224438641807, 'r_trunc': 0.08262526866367498, 'Rs': 0.016598618202631768}, {'theta_Rs': 0.00042442362407183674, 'center_y': -1.0529714519354854, 'center_x': -2.2845213012885983, 'r_trunc': 0.11582999032427202, 'Rs': 0.029993843321230024}, {'theta_Rs': 0.0003808334510828608, 'center_y': 0.4523298291733077, 'center_x': -1.6566454011569762, 'r_trunc': 0.1894563970113983, 'Rs': 0.021861236091319895}, {'theta_Rs': 0.0006697177899920397, 'center_y': -0.7742484180031775, 'center_x': 0.6769297794540827, 'r_trunc': 0.09357310325073884, 'Rs': 0.021209725588454627}, {'theta_Rs': 0.00036550878033988473, 'center_y': -0.3299524726199729, 'center_x': 1.027812068160752, 'r_trunc': 0.10548554831943202, 'Rs': 0.023734097050263008}, {'theta_Rs': 0.00020737939687604035, 'center_y': 0.12421187035711909, 'center_x': -1.10782734206084, 'r_trunc': 0.08892873864059254, 'Rs': 0.017231592555273893}, {'theta_Rs': 0.001564389657678275, 'center_y': 1.079937796659014, 'center_x': -1.8488492626820379, 'r_trunc': 0.4493449950944867, 'Rs': 0.04144591367626979}, {'theta_Rs': 0.0004319257951378307, 'center_y': 0.839289820312816, 'center_x': -2.033832457545488, 'r_trunc': 0.11867380639423557, 'Rs': 0.02325256111701478}, {'theta_Rs': 0.0003325241789202094, 'center_y': -1.3709827439696718, 'center_x': 1.480381482700405, 'r_trunc': 0.20439877578923948, 'Rs': 0.017011082470704264}, {'theta_Rs': 0.0004721793757718969, 'center_y': -0.5062566269961224, 'center_x': 0.7807664293967341, 'r_trunc': 0.3332146838377451, 'Rs': 0.02948586932547085}, {'theta_Rs': 0.0003168428144683217, 'center_y': 2.4456446296672554, 'center_x': 0.9039905992853182, 'r_trunc': 0.1576642154311931, 'Rs': 0.021185551734317076}, {'theta_Rs': 0.0002196781340667007, 'center_y': -0.07993463091495318, 'center_x': -1.0059330628694754, 'r_trunc': 0.12719782011564768, 'Rs': 0.016840195820919713}, {'theta_Rs': 0.0002555034973888659, 'center_y': -0.017574369615783902, 'center_x': -2.584848948896709, 'r_trunc': 0.10546107275534508, 'Rs': 0.020626048315649376}, {'theta_Rs': 0.0003786772236542798, 'center_y': 2.2038017857019057, 'center_x': 1.8783790074213718, 'r_trunc': 0.13499132003988493, 'Rs': 0.021702595732487815}, {'theta_Rs': 0.0002831952786514886, 'center_y': -1.7581239896488097, 'center_x': 0.5811687137438032, 'r_trunc': 0.21303741350628916, 'Rs': 0.016167535705006487}, {'theta_Rs': 0.0002249570361548619, 'center_y': 0.7824038823614918, 'center_x': -2.2096910361106037, 'r_trunc': 0.17125867809343814, 'Rs': 0.012311339192008539}, {'theta_Rs': 0.0002206873411305005, 'center_y': 1.7415345459947305, 'center_x': 0.9044245040023334, 'r_trunc': 0.07785151938407162, 'Rs': 0.014574720584570851}, {'theta_Rs': 0.00040543929526017244, 'center_y': 0.2449068651039232, 'center_x': 1.0368972267612817, 'r_trunc': 0.06547042665947798, 'Rs': 0.026275040838033642}, {'theta_Rs': 0.0040548514263647785, 'center_y': 2.771053606037549, 'center_x': -0.2785507770040946, 'r_trunc': 0.3658192770320809, 'Rs': 0.08297581338431496}, {'theta_Rs': 0.00027091342521114083, 'center_y': -0.7200538405356738, 'center_x': -2.8406928471301742, 'r_trunc': 0.2656353099189596, 'Rs': 0.02083929021138998}, {'theta_Rs': 0.00018761738579640212, 'center_y': 1.587045093518159, 'center_x': -2.013895768967871, 'r_trunc': 0.15303465235092947, 'Rs': 0.016564313070026905}, {'theta_Rs': 0.00020822729250705532, 'center_y': 1.2162421933498746, 'center_x': -1.8956494797062087, 'r_trunc': 0.17193091598225915, 'Rs': 0.017290569825299924}, {'theta_Rs': 0.0005421563519698, 'center_y': -0.10531431478725274, 'center_x': -1.625565340414186, 'r_trunc': 0.22082358135416244, 'Rs': 0.024741464330324255}, {'theta_Rs': 0.000228212466109608, 'center_y': 1.951500459082948, 'center_x': -0.6715245827448437, 'r_trunc': 0.0703285102123727, 'Rs': 0.018780816651798583}, {'theta_Rs': 0.0004671720530281327, 'center_y': 2.0223371042627845, 'center_x': -0.3324795756068763, 'r_trunc': 0.15647805055309488, 'Rs': 0.018812725725970873}, {'theta_Rs': 0.0011389386948692354, 'center_y': -2.6618594685266914, 'center_x': 0.6370942012307313, 'r_trunc': 0.3061849230734347, 'Rs': 0.05310880116234923}, {'theta_Rs': 0.00021089059548730005, 'center_y': -0.8049193414223317, 'center_x': 1.3104433470194907, 'r_trunc': 0.06128277015139497, 'Rs': 0.015253604141797}, {'theta_Rs': 0.00020430937411119386, 'center_y': 1.0847437030986762, 'center_x': 0.9745364237575189, 'r_trunc': 0.14160869183165933, 'Rs': 0.01920518776528372}, {'theta_Rs': 0.000704906583021748, 'center_y': -0.06908136639592027, 'center_x': 0.7891297271767749, 'r_trunc': 0.21091576960101543, 'Rs': 0.038652945706010355}, {'theta_Rs': 0.001407394395366675, 'center_y': 1.4718164727622554, 'center_x': 0.6612032580900107, 'r_trunc': 0.2888861700353565, 'Rs': 0.049299268925351795}, {'theta_Rs': 0.0003929921223735982, 'center_y': 0.5919836094096269, 'center_x': -1.4999637086115027, 'r_trunc': 0.07518108555263753, 'Rs': 0.020448225826317248}, {'theta_Rs': 0.0003536580119307916, 'center_y': 0.6603081832594535, 'center_x': 1.1745175902471345, 'r_trunc': 0.12504438277101262, 'Rs': 0.021599622570147504}, {'theta_Rs': 0.0001982742896703498, 'center_y': -2.515014139902461, 'center_x': 0.8572843164957928, 'r_trunc': 0.0806644151449155, 'Rs': 0.017631238626029277}, {'theta_Rs': 0.000276704025141852, 'center_y': -1.1306161012298286, 'center_x': 2.559467200180471, 'r_trunc': 0.15613908793204684, 'Rs': 0.01544747096784378}, {'theta_Rs': 0.0009938474696807923, 'center_y': 0.22884974233616287, 'center_x': -0.5845708768564312, 'r_trunc': 0.29743599485315775, 'Rs': 0.04440741270444192}, {'theta_Rs': 0.00020791848639957578, 'center_y': -1.2813849886907378, 'center_x': 2.232720231826746, 'r_trunc': 0.15974478245010743, 'Rs': 0.013254275012063894}, {'theta_Rs': 0.00032483078178998634, 'center_y': 1.7381117660462118, 'center_x': -0.3748587023738439, 'r_trunc': 0.2423552391434631, 'Rs': 0.022619486293719546}, {'theta_Rs': 0.00044446459324892106, 'center_y': 0.15082429565073113, 'center_x': -0.2673011932934915, 'r_trunc': 0.15829635991678798, 'Rs': 0.026182925474904667}, {'theta_Rs': 0.0002740711412669073, 'center_y': -0.5168507627727474, 'center_x': -0.28639693134559635, 'r_trunc': 0.2476621275635648, 'Rs': 0.01581646950662085}, {'theta_Rs': 0.0002616950256060199, 'center_y': 2.2000797585484233, 'center_x': 1.7001292054704644, 'r_trunc': 0.2597113299090404, 'Rs': 0.016730340242071366}, {'theta_Rs': 0.00025588957399638555, 'center_y': 0.22110891043283132, 'center_x': 0.7421690425727467, 'r_trunc': 0.12440433158154948, 'Rs': 0.013874168849058448}, {'theta_Rs': 0.000685775999520676, 'center_y': -0.4239145365798761, 'center_x': -2.321698148029836, 'r_trunc': 0.1381687749411414, 'Rs': 0.02578090573960566}, {'theta_Rs': 0.0003639278107882043, 'center_y': -0.12995464987863245, 'center_x': 1.2950889145060547, 'r_trunc': 0.21511012333441162, 'Rs': 0.018164004492115478}, {'theta_Rs': 0.0002853434909081215, 'center_y': -1.5083199472476667, 'center_x': 2.5556245565297844, 'r_trunc': 0.10225251782622685, 'Rs': 0.02072440055213042}, {'theta_Rs': 0.0002146665379479005, 'center_y': -0.4145604438501253, 'center_x': -2.687560156956631, 'r_trunc': 0.1378371343598638, 'Rs': 0.018238170103438152}, {'theta_Rs': 0.00020110159887542497, 'center_y': 0.4644581177421733, 'center_x': -0.7847852569239682, 'r_trunc': 0.1676189193824615, 'Rs': 0.01666655664876223}, {'theta_Rs': 0.0006086839011246789, 'center_y': -2.3108226919617145, 'center_x': -0.2440836531167048, 'r_trunc': 0.3559576094687991, 'Rs': 0.028682188069936308}, {'theta_Rs': 0.00019086945201784503, 'center_y': 2.857730520187156, 'center_x': 0.47588264851132567, 'r_trunc': 0.09193958390500971, 'Rs': 0.015314689892216906}, {'theta_Rs': 0.0003008687711554291, 'center_y': 1.0037192932903902, 'center_x': -1.8739562131613623, 'r_trunc': 0.10294021255723924, 'Rs': 0.022293195988531765}, {'theta_Rs': 0.000520137375307398, 'center_y': 0.8946027076240513, 'center_x': 2.374243811030547, 'r_trunc': 0.16771510326093697, 'Rs': 0.03397141873300887}, {'theta_Rs': 0.00031075625179630275, 'center_y': 2.8473819933907403, 'center_x': 0.3185653748050237, 'r_trunc': 0.24033332266213558, 'Rs': 0.02422698974184977}, {'theta_Rs': 0.00021981880894976746, 'center_y': -1.6197230842715908, 'center_x': -1.587068574669982, 'r_trunc': 0.1431394112551283, 'Rs': 0.02293405376692884}, {'theta_Rs': 0.0003356553701869891, 'center_y': -0.3017473701770651, 'center_x': 2.2063253516965893, 'r_trunc': 0.09253345778612618, 'Rs': 0.02507307381575512}, {'theta_Rs': 0.0002700339276174936, 'center_y': 2.727413090303165, 'center_x': 0.4627767591960491, 'r_trunc': 0.16382730385250482, 'Rs': 0.016648866226316728}, {'theta_Rs': 0.001101005519677152, 'center_y': 0.997967247309613, 'center_x': -0.8195474365056453, 'r_trunc': 0.11462979169120692, 'Rs': 0.04481565647032132}, {'theta_Rs': 0.00021007594175232968, 'center_y': -1.1808642883874514, 'center_x': -2.5344842764139175, 'r_trunc': 0.0927726760342329, 'Rs': 0.01783084037805839}, {'theta_Rs': 0.00027180066866898937, 'center_y': -0.11389413926105155, 'center_x': -0.8459671919315176, 'r_trunc': 0.12163494162384898, 'Rs': 0.020672040791198797}, {'theta_Rs': 0.00027878693510268164, 'center_y': -1.6084646177646913, 'center_x': -0.6533474559889446, 'r_trunc': 0.24963202499153397, 'Rs': 0.01907579288737186}, {'theta_Rs': 0.0005220781486995074, 'center_y': -1.9751040782315419, 'center_x': -1.0344136420420933, 'r_trunc': 0.13128221614550994, 'Rs': 0.020229094105538074}, {'theta_Rs': 0.0003382009548304907, 'center_y': 0.7515026700369207, 'center_x': 0.09111583115325188, 'r_trunc': 0.19208310624312794, 'Rs': 0.019681357769093775}, {'theta_Rs': 0.00017868554397224866, 'center_y': -1.0346779907110406, 'center_x': -1.3889158035029714, 'r_trunc': 0.14454618652484202, 'Rs': 0.01852256231211497}, {'theta_Rs': 0.00018940280996764954, 'center_y': 1.713194710800277, 'center_x': 1.108534894088199, 'r_trunc': 0.1155750912312656, 'Rs': 0.02130791830429981}, {'theta_Rs': 0.00024672498646487396, 'center_y': 0.2652714539369577, 'center_x': -2.8134706863816272, 'r_trunc': 0.24524702161718714, 'Rs': 0.018342202364436566}, {'theta_Rs': 0.00047942581596244595, 'center_y': -1.1209310525417537, 'center_x': -2.2781346838733945, 'r_trunc': 0.2940541506932612, 'Rs': 0.0354173269131282}, {'theta_Rs': 0.00023017589956130896, 'center_y': -0.185728952254099, 'center_x': -2.6704069614570853, 'r_trunc': 0.09697394093244405, 'Rs': 0.01881779774051949}, {'theta_Rs': 0.0002393516513380082, 'center_y': 0.5128845927178447, 'center_x': -1.6887040864976683, 'r_trunc': 0.10949357724686314, 'Rs': 0.014442608894263173}, {'theta_Rs': 0.00047205635399165976, 'center_y': 1.490175180642302, 'center_x': 0.22334902570452336, 'r_trunc': 0.19328749473126472, 'Rs': 0.034166534813219046}, {'theta_Rs': 0.00027787137957594377, 'center_y': 0.24401554859277894, 'center_x': -0.015043465172548651, 'r_trunc': 0.08908183556804132, 'Rs': 0.019865786557932186}, {'theta_Rs': 0.00021581328923209078, 'center_y': 2.707877337812138, 'center_x': 0.5741370285560675, 'r_trunc': 0.07868803110938803, 'Rs': 0.012723144875880565}, {'theta_Rs': 0.0005068478283095335, 'center_y': 0.592660585985527, 'center_x': -1.8728997786816257, 'r_trunc': 0.2045983867221654, 'Rs': 0.029576447601715294}, {'theta_Rs': 0.0002185719827701955, 'center_y': 0.46460245889198676, 'center_x': 1.7275839561711277, 'r_trunc': 0.16375754218453878, 'Rs': 0.018121484319477042}, {'theta_Rs': 0.00023367931718623622, 'center_y': -0.25297592847975386, 'center_x': 2.332379789409848, 'r_trunc': 0.10645526049759353, 'Rs': 0.018902046080998745}, {'theta_Rs': 0.0003389519132486609, 'center_y': 2.3902978432153272, 'center_x': 1.6101479588763141, 'r_trunc': 0.10043051252860408, 'Rs': 0.01625913101571092}, {'theta_Rs': 0.00043631165689988273, 'center_y': 0.6314380355924712, 'center_x': -2.3735825534877812, 'r_trunc': 0.12839515385676767, 'Rs': 0.02167258480613658}, {'theta_Rs': 0.002746800566817938, 'center_y': -2.501535540449383, 'center_x': -0.4285925462181938, 'r_trunc': 0.2995704004183507, 'Rs': 0.09452986137507613}, {'theta_Rs': 0.0003107840787944606, 'center_y': 2.196640264563227, 'center_x': 1.9718492412507693, 'r_trunc': 0.3564231877579341, 'Rs': 0.02298606208068471}, {'theta_Rs': 0.00020416667157631302, 'center_y': -1.758167746096443, 'center_x': -2.3533156863917766, 'r_trunc': 0.08395410868377041, 'Rs': 0.017855947674672436}, {'theta_Rs': 0.0003148436607401747, 'center_y': 1.8625284624937797, 'center_x': -0.4199266931964978, 'r_trunc': 0.09194834880516335, 'Rs': 0.022139526193191646}, {'theta_Rs': 0.0009126182178049956, 'center_y': -0.0645252673863343, 'center_x': -1.9375120065866498, 'r_trunc': 0.18475885059077535, 'Rs': 0.032183878481407004}, {'theta_Rs': 0.0023377022301810423, 'center_y': 2.5042946252633564, 'center_x': -1.6501235200721545, 'r_trunc': 0.5045448228301767, 'Rs': 0.09523907941564541}, {'theta_Rs': 0.0005793441502761774, 'center_y': -2.051050308229603, 'center_x': 0.71301169818856, 'r_trunc': 0.14820270612534195, 'Rs': 0.03470745326399688}, {'theta_Rs': 0.0006108070090386795, 'center_y': -0.7376826233034013, 'center_x': -2.884767703848841, 'r_trunc': 0.14755413573451237, 'Rs': 0.028030950001065293}, {'theta_Rs': 0.00037657773180480925, 'center_y': -0.6559835290493377, 'center_x': 1.8727445671711143, 'r_trunc': 0.15805628267267105, 'Rs': 0.01964589483720121}, {'theta_Rs': 0.00038463317784045417, 'center_y': -1.4589877115727077, 'center_x': -2.2772172880261996, 'r_trunc': 0.10851224277230206, 'Rs': 0.022771488887945505}, {'theta_Rs': 0.0004288228077864227, 'center_y': -1.9976072149932576, 'center_x': -1.629006138228815, 'r_trunc': 0.19081158900045084, 'Rs': 0.025737011828936833}, {'theta_Rs': 0.00022291862306126367, 'center_y': 1.254654380308235, 'center_x': -2.2392015380516654, 'r_trunc': 0.1738614250039776, 'Rs': 0.01973774983156251}, {'theta_Rs': 0.00023833840836714313, 'center_y': 0.6181076877113901, 'center_x': -1.2131735290006935, 'r_trunc': 0.09907178949258993, 'Rs': 0.01698045113479538}, {'theta_Rs': 0.0002145102575456313, 'center_y': 0.5945172893414447, 'center_x': -2.5678419810512354, 'r_trunc': 0.2646129060004853, 'Rs': 0.018043117116286048}, {'theta_Rs': 0.002034649217693411, 'center_y': 0.9399018018663691, 'center_x': 1.8127014382897315, 'r_trunc': 0.23719467987435525, 'Rs': 0.07063356771067329}, {'theta_Rs': 0.00037009304357535697, 'center_y': -2.4379023706527008, 'center_x': -1.4853879230137432, 'r_trunc': 0.1581530759815017, 'Rs': 0.022868572305750536}, {'theta_Rs': 0.0003356354113210476, 'center_y': -1.424698923287845, 'center_x': 0.5009222670225666, 'r_trunc': 0.08999792687417098, 'Rs': 0.032070820959778236}]

    optimizer_simple = Optimizer(x_pos, y_pos, magnification_target=magnification_simple, redshift_list=redshift_list_simple,
                                 lens_model_list=lens_model_list_simple, kwargs_lens=kwargs_lens_simple, multiplane=False, verbose=False)

    optimizer_subs = Optimizer(x_pos, y_pos, magnification_target=magnification_simple, redshift_list=redshift_list_subs,
                               lens_model_list=lens_model_list_subs, kwargs_lens=kwargs_lens_subs, multiplane=False, verbose=True)

    def test_single_plane_correct_model(self):

        """
        test the model used to create the data; should be a perfect fit
        :return:
        """
        kwargs_lens, source, [x_image,y_image] = self.optimizer_simple.optimize(n_particles=50,n_iterations=250)
        index = sort_image_index(x_image, y_image, self.x_pos, self.y_pos)

        x_image = x_image[index]
        y_image = y_image[index]
        mags = self.optimizer_simple.optimizer_amoeba.lensModel.magnification(x_image, y_image, kwargs_lens)
        mags = np.absolute(mags)
        mags *= max(mags)**-1

        npt.assert_almost_equal(x_image, self.x_pos, decimal=4)
        npt.assert_almost_equal(y_image, self.y_pos, decimal=4)
        npt.assert_almost_equal(self.magnification_simple,mags,decimal=2)

    def test_single_plane_incorrect_model(self,tol=0.0035):

        """
        test a model with additional subhalos added; should fit images to within a few m.a.s.
        :param tol:
        :return:
        """
        kwargs_lens, source, [x_image,y_image] = self.optimizer_subs.optimize(n_particles=50,n_iterations=250)
        index = sort_image_index(x_image, y_image, self.x_pos, self.y_pos)
        x_image = x_image[index]
        y_image = y_image[index]

        dx = np.absolute(x_image - self.x_pos)
        dy = np.absolute(y_image - self.y_pos)

        npt.assert_array_less(dx,[tol]*len(dx))
        npt.assert_array_less(dy,[tol]*len(dy))

if __name__ == '__main__':
    pytest.main()

